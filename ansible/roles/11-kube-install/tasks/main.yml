# Controlplane と Workerで共通のタスク
#- debug: msg="{{ ansible_facts }}"

- name: check exisiting /etc/yum.repos.d/kubernetes.repo
  stat:
    path: "/etc/yum.repos.d/kubernetes.repo"
  register: kubernetes_repo

- name: install kubernetes.repo
  become: yes
  template:
    src: kubernetes.repo
    dest: /etc/yum.repos.d/kubernetes.repo
  when:
    - kubernetes_repo.stat.exists == false

- name: check exisiting /etc/yum.repos.d/cri-o.repo
  stat:
    path: "/etc/yum.repos.d/cri-o.repo"
  register: crio_repo

- name: install kubernetes.repo
  become: yes
  template:
    src: cri-o.repo
    dest: /etc/yum.repos.d/cri-o.repo
  when:
    - crio_repo.stat.exists == false

- name: install container-selinux cri-o kubelet kubeadm kubectl
  become: yes
  dnf:
    name:
      - cotainer-selinux
      - cri-o
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: start crio
  become: yes
  systemd:
    name: crio
    state: started
    enabled: yes

- name: enable kubelet
  become: yes
  systemd:
    name: kubelet
    state: started
    enabled: yes